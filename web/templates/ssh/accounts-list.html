{{define "ssh/accounts-list.html"}}
<section class="fdev-section">
  <header class="fdev-header-row">
    <div>
      <h1>SSH / Git Accounts</h1>
      <p>Gerencie chaves e identidades Git por host alias.</p>
    </div>
    <div style="display:flex;gap:8px">
      <button class="fdev-btn fdev-btn--ghost"
        hx-get="/tools/ssh/keys/new"
        hx-target="#drawer-content"
        title="Cria apenas o par de chaves, sem configuração SSH">
        Nova Chave
      </button>
      <button class="fdev-btn"
        hx-get="/tools/ssh/accounts/new"
        hx-target="#drawer-content"
        title="Cria chave + configuração completa de alias SSH">
        Nova Conta
      </button>
    </div>
  </header>

  {{if eq (len .Accounts) 0}}
  <div class="fdev-empty">
    <svg viewBox="0 0 24 24" width="64" height="64" aria-hidden="true"><path fill="currentColor" d="M7 14a5 5 0 1 1 4.9-6H20v2h-2v2h-2v2h-2v2h-2.1A5 5 0 0 1 7 14zm0-2a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
    <h2>Nenhuma chave configurada ainda</h2>
    <p>Crie uma <strong>Nova Chave</strong> para começar rápido, ou use <strong>Nova Conta</strong> para configurar um alias SSH completo.</p>
    <div style="display:flex;gap:8px;justify-content:center">
      <button class="fdev-btn fdev-btn--ghost"
        hx-get="/tools/ssh/keys/new"
        hx-target="#drawer-content">Nova Chave</button>
      <button class="fdev-btn"
        hx-get="/tools/ssh/accounts/new"
        hx-target="#drawer-content">Nova Conta</button>
    </div>
  </div>
  {{else}}
  <div class="fdev-list">
    {{range .Accounts}}
    <article class="fdev-list-card">

      {{/* ── Linha principal ── */}}
      <div class="fdev-list-card-header">
        <button class="fdev-list-card-toggle" type="button" onclick="toggleAccountDetails('{{.ID}}')">
          <div class="fdev-list-card-info">
            <h3 class="fdev-list-card-name">{{.Name}}</h3>
            <p class="fdev-list-card-sub">
              {{.KeyTypeLabel}} · {{.HostAlias}}{{if not .IsSimpleKey}} · {{.Provider}}{{end}}
            </p>
          </div>
          <div style="display:flex;align-items:center;gap:8px">
            {{if .IsSimpleKey}}
              <span class="fdev-pill fdev-pill--purple">Chave simples</span>
            {{end}}
            <span class="fdev-pill {{if .HasKey}}ok{{else}}warn{{end}}">
              {{if .HasKey}}Chave OK{{else}}Sem chave{{end}}
            </span>
          </div>
          <span class="fdev-list-card-chevron" id="chevron-{{.ID}}">
            <svg viewBox="0 0 24 24" width="18" height="18"><path fill="currentColor" d="M7 10l5 5 5-5z"/></svg>
          </span>
        </button>

        <div class="fdev-list-card-actions">
          <button class="fdev-btn fdev-btn--ghost fdev-btn--sm"
            hx-get="/tools/ssh/accounts/{{.ID}}/edit"
            hx-target="#drawer-content">
            {{if .IsSimpleKey}}Configurar SSH{{else}}Editar{{end}}
          </button>
          <button class="fdev-btn fdev-btn--danger fdev-btn--sm"
            hx-delete="/tools/ssh/accounts/{{.ID}}"
            hx-target="#main-content"
            hx-confirm="Deletar {{.Name}}?">Excluir</button>
        </div>
      </div>

      {{/* ── Seção expandida ── */}}
      <div id="account-details-{{.ID}}" class="fdev-list-card-details hidden">
        <div class="fdev-list-card-body">

          {{if .IsSimpleKey}}
          <div class="fdev-info-box">
            Clique em <strong>Configurar SSH</strong> para adicionar provider, hostname e alias SSH
            — necessário para usar com <code>git clone</code> via FactoryDev.
          </div>
          {{else}}
          <div class="fdev-meta">
            <div><strong>Git User:</strong> {{.GitUserName}}</div>
            <div><strong>Git Email:</strong> {{.GitUserEmail}}</div>
            <div><strong>HostName:</strong> {{.HostName}}</div>
          </div>
          <div class="fdev-code-block">
            <div class="fdev-code-head"><strong>Bloco SSH config</strong></div>
            <pre>{{.SSHPreview}}</pre>
          </div>
          {{end}}

          {{if .HasKey}}
          <div class="fdev-code-block">
            <div class="fdev-code-head">
              <strong>Chave Pública</strong>
              <div style="display:flex;gap:6px">
                <button class="fdev-btn fdev-btn--ghost fdev-btn--sm" type="button"
                  onclick="copyElContent(this, 'pub-{{.ID}}')">Copiar</button>
                <button class="fdev-btn fdev-btn--ghost fdev-btn--sm" type="button"
                  onclick="toggleSecret('pub-{{.ID}}', this)">Mostrar</button>
              </div>
            </div>
            <pre id="pub-{{.ID}}" class="secret hidden">{{.PublicKey}}</pre>
          </div>

          <div class="fdev-code-block">
            <div class="fdev-code-head">
              <strong>Chave Privada</strong>
              <button class="fdev-btn fdev-btn--ghost fdev-btn--sm" type="button"
                onclick="toggleSecret('priv-{{.ID}}', this)">Mostrar</button>
            </div>
            <pre id="priv-{{.ID}}" class="secret hidden">{{.PrivateKey}}</pre>
          </div>
          {{if .KeyErrorHint}}<small class="warn">{{.KeyErrorHint}}</small>{{end}}
          {{end}}

          <div class="fdev-actions">
            <button class="fdev-btn fdev-btn--ghost"
              hx-post="/tools/ssh/accounts/{{.ID}}/generate-key"
              hx-target="#main-content"
              {{if .HasKey}}hx-confirm="Chave já existe. Deseja gerar uma nova (sobrescreve a atual)?"{{end}}>
              {{if .HasKey}}Regenerar Chave{{else}}Gerar Chave{{end}}
            </button>
            {{if not .IsSimpleKey}}
            <button class="fdev-btn fdev-btn--ghost"
              hx-post="/tools/ssh/accounts/{{.ID}}/preview-apply"
              hx-target="#drawer-content">Preview Diff</button>
            <button class="fdev-btn fdev-btn--ghost"
              hx-post="/tools/ssh/accounts/{{.ID}}/apply-ssh"
              hx-target="#main-content">Apply SSH Config</button>
            <button class="fdev-btn fdev-btn--ghost"
              hx-post="/tools/ssh/accounts/{{.ID}}/test"
              hx-target="#test-result-{{.ID}}"
              hx-swap="innerHTML">Testar Conexão</button>
            {{end}}
          </div>
          <div id="test-result-{{.ID}}" class="test-result-slot"></div>

        </div>
      </div>

    </article>
    {{end}}
  </div>
  {{end}}
</section>
{{end}}

{{define "content"}}{{template "ssh/accounts-list.html" .}}{{end}}
