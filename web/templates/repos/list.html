{{define "repos/list.html"}}
<section class="fdev-section">
  <header class="fdev-header-row">
    <div>
      <h1>Repositories</h1>
      <p>Repositórios clonados via FactoryDev.</p>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="fdev-btn fdev-btn--ghost fdev-btn--sm"
        hx-get="/tools/repos"
        hx-target="#main-content"
        title="Atualizar status">↻ Atualizar</button>
      <button class="fdev-btn fdev-btn--ghost fdev-btn--sm"
        hx-get="/tools/repos/scan"
        hx-target="#drawer-content">
        Scan Repos
      </button>
      <!-- Pull Todos -->
      <form style="display:flex;align-items:center;gap:5px;margin:0"
        hx-post="/tools/repos/pull-all"
        hx-target="#pull-all-slot"
        hx-swap="innerHTML">
        <label style="display:flex;align-items:center;gap:4px;font-size:12px;color:#5d5950;cursor:pointer;white-space:nowrap">
          <input type="checkbox" name="force" value="1"
            style="width:13px;height:13px;accent-color:var(--accent)">
          Force
        </label>
        <button class="fdev-btn fdev-btn--ghost fdev-btn--sm" type="submit"
          title="Atualiza todos os repositórios gerenciados">⇩ Pull Todos</button>
      </form>
      <button class="fdev-btn"
        hx-get="/tools/repos/clone/new"
        hx-target="#drawer-content">
        Novo Clone
      </button>
    </div>
  </header>

  <div id="pull-all-slot"></div>

  {{if eq (len .Repos) 0}}
  <div class="fdev-empty">
    {{if eq (len .Accounts) 0}}
    <h2>Nenhuma conta SSH disponível</h2>
    <p>Crie uma conta em <strong>SSH / Git Accounts</strong> antes de clonar.</p>
    <button class="fdev-btn"
      hx-get="/tools/ssh/accounts"
      hx-target="#main-content"
      hx-push-url="/tools/ssh/accounts">
      Ir para Accounts
    </button>
    {{else}}
    <h2>Nenhum repositório ainda</h2>
    <p>Use <strong>Novo Clone</strong> ou <strong>Scan Repos</strong> para adicionar repositórios.</p>
    {{end}}
  </div>
  {{else}}
  <div class="fdev-list">
    {{range .Repos}}
    <article class="fdev-list-card" x-data="{open:false,tab:'overview'}">
      <div class="fdev-list-card-header">
        <button class="fdev-list-card-toggle" @click="open=!open">
          <div class="fdev-list-card-info">
            <h3 class="fdev-list-card-name">{{.Name}}</h3>
            <p class="fdev-list-card-sub">{{.LocalPath}}</p>
          </div>
          <span class="fdev-list-card-chevron" :class="{open:open}">
            <svg width="14" height="14" viewBox="0 0 14 14" fill="none"><path d="M3 5l4 4 4-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </span>
        </button>
        <div class="fdev-list-card-actions">
          <span id="repo-status-{{.ID}}" class="fdev-repo-status-wrap">
            {{if not .Accessible}}
              <span class="fdev-repo-status fdev-repo-status--error">não encontrado</span>
            {{else}}
              <span class="fdev-repo-branch">⎇ {{.Branch}}</span>
              <span class="fdev-repo-status {{if .IsClean}}fdev-repo-status--ok{{else}}fdev-repo-status--dirty{{end}}">
                {{.StatusShort}}
              </span>
            {{end}}
          </span>
          <button class="fdev-btn fdev-btn--ghost fdev-btn--sm"
            hx-get="/tools/repos/{{.ID}}/status"
            hx-target="#repo-status-{{.ID}}"
            hx-swap="innerHTML"
            title="Atualizar status">↻</button>
          <button class="fdev-btn fdev-btn--danger fdev-btn--sm"
            hx-delete="/tools/repos/{{.ID}}"
            hx-target="#main-content"
            hx-confirm="Remover {{.Name}} da lista?">Remover</button>
        </div>
      </div>

      <div class="fdev-list-card-details" x-show="open" x-cloak>
        <!-- Tab bar -->
        <div class="fdev-tab-bar">
          <button class="fdev-tab-btn" :class="{active:tab==='overview'}"
            @click="tab='overview'"
            hx-get="/tools/repos/{{.ID}}/tab/overview"
            hx-target="#repo-tab-{{.ID}}"
            hx-swap="innerHTML"
            hx-trigger="click">
            Overview
          </button>
          <button class="fdev-tab-btn" :class="{active:tab==='config'}"
            @click="tab='config'"
            hx-get="/tools/repos/{{.ID}}/tab/config"
            hx-target="#repo-tab-{{.ID}}"
            hx-swap="innerHTML"
            hx-trigger="click">
            Config
          </button>
          <button class="fdev-tab-btn" :class="{active:tab==='commits'}"
            @click="tab='commits'"
            hx-get="/tools/repos/{{.ID}}/tab/commits"
            hx-target="#repo-tab-{{.ID}}"
            hx-swap="innerHTML"
            hx-trigger="click">
            Commits
          </button>
          <button class="fdev-tab-btn" :class="{active:tab==='branches'}"
            @click="tab='branches'"
            hx-get="/tools/repos/{{.ID}}/tab/branches"
            hx-target="#repo-tab-{{.ID}}"
            hx-swap="innerHTML"
            hx-trigger="click">
            Branches
          </button>
        </div>
        <!-- Tab content: carregado via HTMX, default overview -->
        <div id="repo-tab-{{.ID}}"
          hx-get="/tools/repos/{{.ID}}/tab/overview"
          hx-trigger="intersect once"
          hx-swap="innerHTML"
          class="fdev-list-card-body">
        </div>
      </div>

      <div class="fdev-list-card-meta-strip">
        {{if .URL}}<span><strong>URL:</strong> {{.URL}}</span>{{end}}
        {{if .AccountName}}<span><strong>Conta:</strong> {{.AccountName}}</span>{{end}}
        <span><strong>Clonado em:</strong> {{.ClonedAt.Format "02/01/2006 15:04"}}</span>
      </div>
    </article>
    {{end}}
  </div>
  {{end}}
</section>
{{end}}

{{define "content"}}{{template "repos/list.html" .}}{{end}}
